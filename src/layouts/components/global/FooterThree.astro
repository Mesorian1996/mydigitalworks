---
import { parseTomlToJson } from "@/lib/utils/tomlUtils";
import { markdownify } from "@/lib/utils/textConverter";
import { splitProtectedText } from "@/lib/utils/splitProtectedText";
import SocialComponent from "@/components/widgets/Social.astro";
import social from "@/config/social.json";
import { getEntryCTM } from "@/lib/customContentLoader.astro";

const config = parseTomlToJson();

let {
  copyright,
  footerDescription,
  contactInfo: { address, email, phone },
} = config.settings;
const { footerSpaceTop = true } = Astro.props;

const {
  data: { title, description },
} = await getEntryCTM("sections", "call-to-action");

footerDescription = footerDescription || "";

const copyrightText =
  copyright.text ||
  "Copyright © {{ year }} MY Digital Works. Alle Rechte vorbehalten.";
const copyrightParts = splitProtectedText(copyrightText);

// Web3Forms Access Key
// IMPORTANT: Create your key at https://web3forms.com with the email where you want to receive submissions
// For testing: Use Mesorian96@gmx.de
// For production: Use kontakt@mydigitalworks.de
const WEB3FORMS_KEY = "3a997d22-0d88-4e6e-bd4e-1ef591465416"; // ← REPLACE WITH YOUR KEY FROM WEB3FORMS.COM
---

<footer
  id="footer-with-contact"
  class:list={[ "bg-[#0A1A2F] text-white", !footerSpaceTop && "mt-0"]}>
  <div class="container pb-8 md:pb-16">
    <div
      class="grid grid-cols-1 gap-y-12 border-b border-white/15 py-16 md:py-24 lg:grid-cols-2 lg:gap-x-16 xl:gap-x-24">
      
      <!-- Left Column: Text + Social -->
      <div class="space-y-8 lg:space-y-10">
        {
          title && (
            <h2
              class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-[#f7b97d] leading-tight"
              set:html={markdownify(title)}
            />
          )
        }
        {
          description && (
            <div
              class="w-full max-w-lg text-base md:text-lg text-white/80 leading-relaxed"
              set:html={markdownify(description, true)}
            />
          )
        }
        <div class="space-y-6">
          {
            config.settings.copyright?.enable && (
              <ul class="has-list has-list-slash prose-a:text-inherit flex flex-wrap gap-y-2 text-white/70">
                {copyrightParts.map((value) => (
                  <li class="prose-a:text-white/70 prose-a:hover:text-white">
                    <span set:html={markdownify(value)} />
                  </li>
                ))}
              </ul>
            )
          }

          <SocialComponent
            size="lg"
            layout="dark"
            class="gap-5"
            linkType="follow"
            list={social.main.filter((s) => s.enable)}
          />
        </div>
      </div>
      
      <!-- Right Column: Contact Form -->
      <div class="w-full">
        <div class="rounded-2xl bg-[#0f2643] p-6 md:p-8 shadow-2xl">
          <form id="web3forms-contact" class="space-y-5">
            
            <!-- Name Row (Side by Side auf Desktop) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Vorname -->
              <div class="space-y-2">
                <label for="vorname" class="block text-sm font-medium text-white/90">
                  Vorname <span class="text-[#f7b97d]">*</span>
                </label>
                <input 
                  type="text" 
                  name="vorname" 
                  id="vorname" 
                  required
                  class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white caret-white placeholder:text-white/50 transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30"
                  placeholder="Max"
                >
              </div>
              
              <!-- Nachname -->
              <div class="space-y-2">
                <label for="nachname" class="block text-sm font-medium text-white/90">
                  Nachname <span class="text-[#f7b97d]">*</span>
                </label>
                <input 
                  type="text" 
                  name="nachname" 
                  id="nachname" 
                  required
                  class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white caret-white placeholder:text-white/50 transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30"
                  placeholder="Mustermann"
                >
              </div>
            </div>
            
            <!-- Email + Phone Row -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Email -->
              <div class="space-y-2">
                <label for="email" class="block text-sm font-medium text-white/90">
                  E-Mail <span class="text-[#f7b97d]">*</span>
                </label>
                <input 
                  type="email" 
                  name="email" 
                  id="email" 
                  required
                  class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white caret-white placeholder:text-white/50 transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30"
                  placeholder="max@beispiel.de"
                >
              </div>
              
              <!-- Telefon -->
              <div class="space-y-2">
                <label for="telefon" class="block text-sm font-medium text-white/90">
                  Telefon <span class="text-[#f7b97d]">*</span>
                </label>
                <input 
                  type="tel" 
                  name="telefon" 
                  id="telefon" 
                  required
                  class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white caret-white placeholder:text-white/50 transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30"
                  placeholder="+49 123 456789"
                >
              </div>
            </div>
            
            <!-- Projektart Dropdown (Full Width) -->
            <div class="space-y-2">
              <label for="projektart" class="block text-sm font-medium text-white/90">
                Projektart
              </label>
              <select 
                name="projektart" 
                id="projektart"
                class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30 appearance-none cursor-pointer"
                style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.7)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25rem; padding-right: 2.5rem;"
              >
                <option value="">Bitte wählen...</option>
                <option value="Starter Paket">Starter Paket</option>
                <option value="Business Paket">Business Paket</option>
                <option value="Individuelles Paket">Individuelles Paket</option>
                <option value="Buchhaltung digital">Buchhaltung digital</option>
                <option value="Google Profile">Google Profile</option>
                <option value="SEO">SEO & Local SEO</option>
                <option value="Webhosting">Webhosting & Wartung</option>
              </select>
            </div>
            
            <!-- Nachricht (Full Width) -->
            <div class="space-y-2">
              <label for="nachricht" class="block text-sm font-medium text-white/90">
                Nachricht
              </label>
              <textarea 
                name="nachricht" 
                id="nachricht"
                rows="4"
                class="w-full rounded-lg border border-white/30 bg-[#0A1A2F]/50 px-4 py-3 text-white caret-white placeholder:text-white/50 transition-all duration-300 focus:border-[#f7b97d] focus:bg-[#0A1A2F]/70 focus:outline-none focus:ring-2 focus:ring-[#f7b97d]/30 resize-none"
                placeholder="Beschreiben Sie kurz Ihr Anliegen..."
              ></textarea>
            </div>
            
            <!-- Submit Button -->
            <div class="pt-2 space-y-3">
              <button 
                type="submit" 
                class="group relative w-full overflow-hidden rounded-lg bg-[#f7b97d] px-8 py-4 font-semibold text-[#0A1A2F] transition-all duration-300 hover:bg-[#efba87] hover:shadow-[0_8px_30px_rgba(247,185,125,0.4)] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none disabled:active:scale-100"
              >
                <span class="flex items-center justify-center gap-2 transition-transform duration-300 group-hover:translate-x-1">
                  <span>Absenden</span>
                  <svg class="h-5 w-5 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                  </svg>
                </span>
              </button>
              
              <!-- Datenschutz Hinweis -->
              <p class="text-xs text-white/60 text-center leading-relaxed">
                Mit dem Absenden stimmst du unserer <a href="/datenschutz" class="text-[#f7b97d] hover:text-[#efba87] underline underline-offset-2 transition-colors" target="_blank">Datenschutzerklärung</a> zu.
              </p>
            </div>
            
            <!-- Success Message -->
            <div id="success-message" class="hidden rounded-lg bg-gradient-to-r from-green-500 to-green-600 p-4 shadow-lg animate-in fade-in slide-in-from-top-2 duration-300">
              <div class="flex items-start gap-3">
                <svg class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="text-sm leading-relaxed">
                  <strong class="font-semibold">Vielen Dank!</strong><br>
                  Wir haben deine Nachricht erhalten und melden uns zeitnah bei dir.
                </div>
              </div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden rounded-lg bg-gradient-to-r from-red-500 to-red-600 p-4 shadow-lg animate-in fade-in slide-in-from-top-2 duration-300">
              <div class="flex items-start gap-3">
                <svg class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="text-sm leading-relaxed">
                  <strong class="font-semibold">Fehler beim Senden</strong><br>
                  Bitte versuche es erneut oder schreibe uns direkt an <a href="mailto:kontakt@mydigitalworks.de" class="underline underline-offset-2 hover:text-white/90">kontakt@mydigitalworks.de</a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      
    </div>
    
    <!-- Footer Bottom -->
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 pt-8 text-sm text-white/70">
      <div class="flex flex-wrap items-center gap-4">
        <a class="hover:text-white transition-colors" href="/impressum">Impressum</a>
        <a class="hover:text-white transition-colors" href="/datenschutz">Datenschutz</a>
        <a class="hover:text-white transition-colors" href="/faq">FAQ</a>
      </div>
      <div class="text-left md:text-right space-y-1">
        {address && <p set:html={markdownify(address)} />}
        {phone && <p set:html={markdownify(phone)} />}
        {email && <p set:html={markdownify(email)} />}
      </div>
    </div>
  </div>
</footer>

<script define:vars={{ WEB3FORMS_KEY }}>
  // Web3Forms Implementation
  const form = document.getElementById('web3forms-contact');
  const submitBtn = form?.querySelector('button[type="submit"]');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  if (form && submitBtn) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      
      // Add Web3Forms Access Key
      // NOTE: The email address is determined by the Access Key you created on web3forms.com
      // All submissions will go to the email you used when creating the key
      formData.append("access_key", WEB3FORMS_KEY);
      
      // Store original button content
      const originalHTML = submitBtn.innerHTML;
      
      // Update button state
      submitBtn.innerHTML = `
        <span class="flex items-center justify-center gap-2">
          <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Wird gesendet...</span>
        </span>
      `;
      submitBtn.disabled = true;
      
      // Hide previous messages
      if (successMessage) successMessage.classList.add('hidden');
      if (errorMessage) errorMessage.classList.add('hidden');
      
      try {
        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Success!
          if (successMessage) {
            successMessage.classList.remove('hidden');
            
            // Smooth scroll to message
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
              successMessage.classList.add('hidden');
            }, 8000);
          }
          
          // Reset form
          form.reset();
          
        } else {
          // Error from Web3Forms
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
        
      } catch (error) {
        // Network error
        console.error("Form submission error:", error);
        if (errorMessage) {
          errorMessage.classList.remove('hidden');
          errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
      }
    });
  }
</script>

<style>
  /* Custom Animations */
  @keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slide-in-from-top-2 {
    from { transform: translateY(-0.5rem); }
    to { transform: translateY(0); }
  }
  
  .animate-in {
    animation-fill-mode: both;
  }
  
  .fade-in {
    animation-name: fade-in;
  }
  
  .slide-in-from-top-2 {
    animation-name: slide-in-from-top-2;
  }
  
  .duration-300 {
    animation-duration: 300ms;
  }
</style>